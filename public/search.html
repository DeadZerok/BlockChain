<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Búsqueda de Tarros de Aceite</title>
    
    <!-- Enlace a Bootstrap para estilos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="container">
        <h1 class="mt-5">Búsqueda de Tarros Registrados</h1>
        
        <!-- Formulario de búsqueda por ID de producto -->
        <form id="searchForm" class="mt-4">
            <div class="form-group">
                <label for="searchProductId">Buscar por ID del Producto</label>
                <input type="text" class="form-control" id="searchProductId">
            </div>
            <button type="submit" class="btn btn-info">Buscar</button>
            <button id="registro" type="submit" class="btn btn-success">registrar tarro</button>
        </form>

        <!-- Sección donde se mostrará la lista de tarros registrados -->
        <div id="tarrosList" class="mt-4"></div>
    </div>

    
    <script>
        let selectedProductId = null;

        // Función para cargar los tarros registrados
        async function loadTarros() {
            const response = await fetch('/chain');
            const chain = await response.json();
            const tarrosList = document.getElementById('tarrosList');
            tarrosList.innerHTML = '';

            // Itera sobre la cadena de bloques para mostrar los tarros
            chain.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'border p-2 mb-2';
                blockDiv.innerHTML = `
                    <strong>ID:</strong> ${block.data.productId} <br>
                    <strong>Nombre:</strong> ${block.data.productNombre} <br>
                    <strong>Fecha de Registro:</strong> ${new Date(block.data.productFecha).toLocaleDateString()} <br>
                    <strong>Hash:</strong> ${block.hash} <br>
                    <strong>Estado:</strong> ${block.sold ? 'Vendido' : 'Disponible'} <br>
                    <div class="dropdown">
                        <button type="button" class="btn btn-warning dropdown-toggle mt-2" data-toggle="dropdown" aria-expanded="false">
                            Marcar como Vendido
                        </button>
                        <form class="dropdown-menu p-4" onsubmit="sellTarro(event, '${block.data.productId}')">
                            <div class="mb-3">
                                <label for="compradorNombre-${block.data.productId}" class="form-label">Nombre del Comprador</label>
                                <input type="text" class="form-control" id="compradorNombre-${block.data.productId}" placeholder="Nombre del comprador" required>
                            </div>
                            <div class="mb-3">
                                <label for="compradorFecha-${block.data.productId}" class="form-label">Fecha de Compra</label>
                                <input type="date" class="form-control" id="compradorFecha-${block.data.productId}" required>
                            </div>
                            <button type="submit" class="btn btn-success">Guardar y Marcar como Vendido</button>
                        </form>
                    </div>
                    <button class="btn btn-info mt-2 ml-2" onclick="mostrarInformacion('${block.data.productId}')">Información</button>
                    <div id="info-${block.data.productId}" style="display: none;" class="mt-2">
                        <strong>Comprador:</strong> ${block.data.compradorNombre || 'N/A'} <br>
                        <strong>Fecha de Compra:</strong> ${block.data.compradorFecha ? new Date(block.data.compradorFecha).toLocaleDateString() : 'N/A'}
                    </div>
                `;
                tarrosList.appendChild(blockDiv);
            });
        }

        // Función para marcar un tarro como vendido
        async function sellTarro(event, productId) {
            event.preventDefault();
            const compradorNombre = document.getElementById(`compradorNombre-${productId}`).value;
            const compradorFecha = document.getElementById(`compradorFecha-${productId}`).value;

            const response = await fetch('/sellTarro', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    productId, 
                    compradorNombre, 
                    compradorFecha 
                })
            });

            const data = await response.json();
            if (response.ok) {
                alert(data.message);

                // Actualiza los datos en el bloque "Información" sin recargar la página
                const infoDiv = document.getElementById(`info-${productId}`);
                infoDiv.innerHTML = `
                    <strong>Comprador:</strong> ${compradorNombre} <br>
                    <strong>Fecha de Compra:</strong> ${new Date(compradorFecha).toLocaleDateString()}
                `;
                infoDiv.style.display = 'block'; // Mostrar la información después de guardar

            } else {
                alert('Error: ' + data.message);
            }
        }

        // Función para mostrar la información del comprador
        function mostrarInformacion(productId) {
            const infoDiv = document.getElementById(`info-${productId}`);
            infoDiv.style.display = infoDiv.style.display === 'none' ? 'block' : 'none';
        }

        // Evento para manejar la búsqueda de un tarro por su ID
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('searchProductId').value;
            
            // Si no se ingresa un ID, se cargan todos los tarros
            if (!productId) {
                loadTarros();
                return;
            }

            // Realiza una búsqueda filtrada en la cadena
            const response = await fetch('/chain');
            const chain = await response.json();
            const tarrosList = document.getElementById('tarrosList');
            tarrosList.innerHTML = ''; // Limpia la lista

            const filteredBlock = chain.find(block => block.data.productId === productId);

            if (filteredBlock) {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'border p-2 mb-2';
                blockDiv.innerHTML = `
                    <strong>ID:</strong> ${filteredBlock.data.productId} <br>
                    <strong>Nombre:</strong> ${filteredBlock.data.productNombre} <br>
                    <strong>Fecha de Registro:</strong> ${new Date(filteredBlock.data.productFecha).toLocaleDateString()} <br>
                    <strong>Hash:</strong> ${filteredBlock.hash} <br>
                    <strong>Estado:</strong> ${filteredBlock.sold ? 'Vendido' : 'Disponible'} <br>
                    <div class="dropdown">
                        <button type="button" class="btn btn-warning dropdown-toggle mt-2" data-toggle="dropdown" aria-expanded="false">
                            Marcar como Vendido
                        </button>
                        <form class="dropdown-menu p-4" onsubmit="sellTarro(event, '${filteredBlock.data.productId}')">
                            <div class="mb-3">
                                <label for="compradorNombre-${filteredBlock.data.productId}" class="form-label">Nombre del Comprador</label>
                                <input type="text" class="form-control" id="compradorNombre-${filteredBlock.data.productId}" placeholder="Nombre del comprador" required>
                            </div>
                            <div class="mb-3">
                                <label for="compradorFecha-${filteredBlock.data.productId}" class="form-label">Fecha de Compra</label>
                                <input type="date" class="form-control" id="compradorFecha-${filteredBlock.data.productId}" required>
                            </div>
                            <button type="submit" class="btn btn-success">Guardar y Marcar como Vendido</button>
                        </form>
                    </div>
                    <button class="btn btn-info mt-2 ml-2" onclick="mostrarInformacion('${filteredBlock.data.productId}')">Información</button>
                    <div id="info-${filteredBlock.data.productId}" style="display: none;" class="mt-2">
                        <strong>Comprador:</strong> ${filteredBlock.data.compradorNombre || 'N/A'} <br>
                        <strong>Fecha de Compra:</strong> ${filteredBlock.data.compradorFecha ? new Date(filteredBlock.data.compradorFecha).toLocaleDateString() : 'N/A'}
                    </div>
                `;
                tarrosList.appendChild(blockDiv);
            } else {
                tarrosList.innerHTML = '<p class="text-danger">No se encontró ningún tarro con ese ID.</p>';
            }
        });

        // Carga la lista completa de tarros cuando se abre la página
        loadTarros();

        // Redirige a la página de registro cuando se hace clic en "Registrar Tarro"
    document.getElementById('registro').addEventListener('click', () => {
        window.location.href = '/';  // Cambia la URL si es necesario
    });
    </script>


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
